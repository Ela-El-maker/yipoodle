{% extends "base.html" %} {% block content %}
<div class="section-header">
  <h2>
    <svg
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    >
      <polygon points="5 3 19 12 5 21 5 3" />
    </svg>
    Run Console
  </h2>
</div>

<div class="grid-2">
  <section class="card">
    <h2>
      <svg
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M12 20h9" />
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
      </svg>
      Configure Run
    </h2>
    <form id="run-form">
      <label
        >Mode
        <select name="mode" id="mode">
          {% for mode in modes %}
          <option value="{{ mode }}">{{ mode }}</option>
          {% endfor %}
        </select>
      </label>

      <label
        >Question
        <textarea
          name="question"
          id="question"
          rows="3"
          placeholder="Ask a question or monitoring prompt"
        ></textarea>
      </label>

      <label
        >Index
        <select name="index" id="index">
          <option value="">— default —</option>
          {% for idx in indexes %}
          <option value="{{ idx }}">{{ idx }}</option>
          {% endfor %}
        </select>
      </label>

      <div class="grid-2">
        <label
          >Sources Config
          <input
            type="text"
            name="sources_config"
            id="sources_config"
            value="{{ sources_config }}"
          />
        </label>
        <label
          >Automation Config
          <input
            type="text"
            name="automation_config"
            id="automation_config"
            value="{{ automation_config }}"
          />
        </label>
      </div>

      <label
        >Output Path <span class="muted text-sm">(optional)</span>
        <input
          type="text"
          name="output_path"
          id="output_path"
          placeholder="runs/output/my_run.md"
        />
      </label>

      <details style="margin-top: 8px">
        <summary>Options JSON</summary>
        <div>
          <textarea name="options" id="options" rows="6">{}</textarea>
        </div>
      </details>

      <div style="margin-top: 12px">
        <button type="submit">
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polygon points="5 3 19 12 5 21 5 3" />
          </svg>
          Start Run
        </button>
      </div>
    </form>
  </section>

  <section class="card">
    <h2>
      <svg
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <polyline points="4 17 10 11 4 5" />
        <line x1="12" y1="19" x2="20" y2="19" />
      </svg>
      Run Output
    </h2>
    <div id="run-meta" class="muted" style="margin-bottom: 12px">
      No run started. Configure and click "Start Run".
    </div>
    <pre
      id="run-log"
      class="log"
      style="min-height: 300px; max-height: calc(100vh - 360px)"
    ></pre>
  </section>
</div>

<script>
  const form = document.getElementById("run-form");
  const runMeta = document.getElementById("run-meta");
  const runLog = document.getElementById("run-log");

  function appendLog(line) {
    runLog.textContent += line + "\n";
    runLog.scrollTop = runLog.scrollHeight;
  }

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    runLog.textContent = "";
    runMeta.innerHTML =
      '<span class="status-dot pending"></span> Starting run…';

    let options = {};
    const rawOptions = document.getElementById("options").value.trim();
    if (rawOptions) {
      try {
        options = JSON.parse(rawOptions);
      } catch (err) {
        runMeta.textContent = "Invalid options JSON: " + err;
        return;
      }
    }

    const payload = {
      mode: document.getElementById("mode").value,
      question: document.getElementById("question").value || null,
      index: document.getElementById("index").value || null,
      sources_config: document.getElementById("sources_config").value,
      automation_config: document.getElementById("automation_config").value,
      output_path: document.getElementById("output_path").value || null,
      options,
    };

    const resp = await fetch("/api/v1/runs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!resp.ok) {
      const body = await resp.text();
      runMeta.innerHTML =
        '<span class="status-dot error"></span> Failed to start run: ' + body;
      return;
    }

    const created = await resp.json();
    runMeta.innerHTML = `<span class="status-dot ok"></span> Run <code>${created.run_id}</code> queued. <a href="/runs?run_id=${created.run_id}">Open detail →</a>`;
    appendLog(
      `[${new Date().toLocaleTimeString()}] Run ${created.run_id} queued`,
    );

    if (!!window.EventSource) {
      const es = new EventSource(created.events_url);
      es.addEventListener("run_event", (evt) => {
        try {
          const item = JSON.parse(evt.data);
          const lvl = item.level || "info";
          appendLog(
            `[${lvl.toUpperCase()}] ${item.message}${item.payload ? " " + JSON.stringify(item.payload) : ""}`,
          );
        } catch (_e) {
          appendLog(evt.data);
        }
      });
      es.addEventListener("run_final", (evt) => {
        appendLog(`\n✓ FINAL: ${evt.data}`);
        runMeta.innerHTML = `<span class="status-dot ok"></span> Run <code>${created.run_id}</code> completed. <a href="/runs?run_id=${created.run_id}">Open detail →</a>`;
        es.close();
      });
      es.addEventListener("error", () => {
        appendLog("[WARN] Event stream disconnected.");
        es.close();
      });
    } else {
      appendLog("[WARN] SSE not supported in this browser.");
    }
  });
</script>
{% endblock %}
