{% extends "base.html" %}
{% block content %}
<section class="chat-shell">
  <aside class="chat-sidebar card">
    <div class="row">
      <h2>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Sessions
      </h2>
      <button id="new-session" type="button">+ New</button>
    </div>
    <ul id="sessions" class="sessions"></ul>
  </aside>

  <section class="chat-main card">
    <div id="chat-meta" class="muted">Select or create a chat session to begin.</div>
    <div id="messages" class="messages"></div>

    <form id="chat-form" class="chat-form">
      <div class="form-row">
        <label>Mode
          <select id="mode">{% for mode in modes %}
            <option value="{{ mode }}"{% if mode == default_mode %} selected{% endif %}>{{ mode }}</option>{% endfor %}
          </select>
        </label>
        <label>Options JSON
          <textarea id="options" rows="1" style="min-height:38px">{}</textarea>
        </label>
      </div>
      <label>Message
        <textarea id="message-input" rows="3" placeholder="Ask anything â€” research, monitor, query..."></textarea>
      </label>
      <div class="row">
        <span id="send-status" class="muted text-sm"></span>
        <button type="submit">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Send
        </button>
      </div>
    </form>
  </section>
</section>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const sessionsEl = document.getElementById("sessions");
const messagesEl = document.getElementById("messages");
const metaEl = document.getElementById("chat-meta");
const formEl = document.getElementById("chat-form");
const newSessionBtn = document.getElementById("new-session");
const messageInput = document.getElementById("message-input");
const modeSelect = document.getElementById("mode");
const optionsEl = document.getElementById("options");
const sendStatus = document.getElementById("send-status");
let currentSessionId = null;
let currentEventSource = null;

if (typeof marked !== "undefined") {
  marked.setOptions({ breaks: true, gfm: true });
}

function esc(s) {
  return (s || "").replace(/[&<>"']/g, function(m) {
    return {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m];
  });
}

function renderMarkdown(text) {
  if (typeof marked !== "undefined" && text) {
    try { return marked.parse(text); } catch(_e) {}
  }
  return '<pre class="msg-body">' + esc(text) + '</pre>';
}

function renderSessions(items) {
  sessionsEl.innerHTML = "";
  if (!items.length) {
    sessionsEl.innerHTML = '<li class="muted text-sm" style="padding:12px;text-align:center;">No sessions yet</li>';
    return;
  }
  for (var i = 0; i < items.length; i++) {
    var row = items[i];
    var li = document.createElement("li");
    li.className = "session-item" + (row.id === currentSessionId ? " active" : "");
    var title = row.title || row.id.substring(0, 12) + "\u2026";
    li.innerHTML = '<button type="button" data-session-id="' + row.id + '">' + esc(title) + '</button>';
    sessionsEl.appendChild(li);
  }
  var btns = sessionsEl.querySelectorAll("button[data-session-id]");
  for (var j = 0; j < btns.length; j++) {
    btns[j].addEventListener("click", (function(btn) {
      return function() { selectSession(btn.getAttribute("data-session-id")); };
    })(btns[j]));
  }
}

function renderMessages(items) {
  messagesEl.innerHTML = "";
  if (!items.length) {
    messagesEl.innerHTML = '<div class="muted" style="text-align:center;padding:40px 20px;">No messages yet. Send one to get started.</div>';
    return;
  }
  for (var i = 0; i < items.length; i++) {
    var row = items[i];
    var div = document.createElement("div");
    div.className = "msg " + row.role;
    var meta = row.metadata || {};
    var details = meta.details || {};
    var sourceType = "deterministic";
    if (details.ask_handler_used === "model_fallback" || details.deterministic === false) {
      sourceType = "model_fallback";
    }
    var modeBadge = row.mode_used ? '<span class="badge">' + esc(row.mode_used) + '</span>' : "";
    var sourceBadge = row.role === "assistant" ? '<span class="badge ' + (sourceType === "model_fallback" ? "warn" : "success") + '">' + esc(sourceType) + '</span>' : "";
    var status = row.role === "assistant"
      ? '<div class="muted text-sm" style="margin-top:8px;">status: ' + esc(row.status) + ' ' + modeBadge + ' ' + sourceBadge + '</div>'
      : "";
    var err = row.error_message ? '<div class="error text-sm" style="margin-top:6px;">' + esc(row.error_message) + '</div>' : "";
    var roleIcon = row.role === "user"
      ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'
      : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>';
    var body = row.role === "assistant"
      ? '<div class="msg-body-md">' + renderMarkdown(row.content_markdown || "") + '</div>'
      : '<pre class="msg-body">' + esc(row.content_markdown || "") + '</pre>';
    div.innerHTML = '<div class="msg-role">' + roleIcon + ' ' + esc(row.role) + '</div>' + body + status + err;
    messagesEl.appendChild(div);
  }
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function loadSessions() {
  var resp = await fetch("/api/v1/chat/sessions");
  if (!resp.ok) return;
  var body = await resp.json();
  renderSessions(body.sessions || []);
  if (!currentSessionId && body.sessions && body.sessions.length > 0) {
    await selectSession(body.sessions[0].id);
  }
}

async function createSession() {
  var resp = await fetch("/api/v1/chat/sessions", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({})
  });
  if (!resp.ok) return null;
  var row = await resp.json();
  await loadSessions();
  await selectSession(row.id);
  return row.id;
}

async function selectSession(sessionId) {
  currentSessionId = sessionId;
  await loadSessions();
  await loadMessages();
}

async function loadMessages() {
  if (!currentSessionId) {
    messagesEl.innerHTML = "";
    metaEl.textContent = "Select or create a chat session.";
    return;
  }
  var resp = await fetch("/api/v1/chat/sessions/" + encodeURIComponent(currentSessionId) + "/messages");
  if (!resp.ok) return;
  var body = await resp.json();
  metaEl.innerHTML = 'Session <code>' + esc(currentSessionId.substring(0, 12)) + '\u2026</code> \u00b7 ' + body.count + ' messages';
  renderMessages(body.messages || []);
}

function subscribeEvents(eventsUrl) {
  if (currentEventSource) { currentEventSource.close(); currentEventSource = null; }
  if (!window.EventSource) return;
  sendStatus.textContent = "Thinking\u2026";
  currentEventSource = new EventSource(eventsUrl);
  currentEventSource.addEventListener("chat_event", async function() {
    sendStatus.textContent = "Receiving\u2026";
    await loadMessages();
  });
  currentEventSource.addEventListener("chat_final", async function() {
    sendStatus.textContent = "";
    await loadMessages();
    if (currentEventSource) { currentEventSource.close(); currentEventSource = null; }
  });
  currentEventSource.addEventListener("error", async function() {
    sendStatus.textContent = "";
    await loadMessages();
  });
}

newSessionBtn.addEventListener("click", async function() { await createSession(); });

formEl.addEventListener("submit", async function(event) {
  event.preventDefault();
  if (!currentSessionId) {
    var sid = await createSession();
    if (!sid) return;
  }
  var content = messageInput.value.trim();
  if (!content) return;
  var options = {};
  try { options = JSON.parse(optionsEl.value || "{}"); }
  catch (err) { metaEl.textContent = "Invalid options JSON: " + err; return; }
  var payload = { content: content, mode: modeSelect.value, options: options, stream: true };
  sendStatus.textContent = "Sending\u2026";
  var resp = await fetch("/api/v1/chat/sessions/" + encodeURIComponent(currentSessionId) + "/messages", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });
  if (!resp.ok) {
    sendStatus.textContent = "";
    metaEl.textContent = "Failed to send: " + (await resp.text());
    return;
  }
  var created = await resp.json();
  messageInput.value = "";
  await loadMessages();
  subscribeEvents(created.events_url);
});

messageInput.addEventListener("keydown", function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
    e.preventDefault();
    formEl.dispatchEvent(new Event("submit"));
  }
});

loadSessions();
</script>
{% endblock %}
